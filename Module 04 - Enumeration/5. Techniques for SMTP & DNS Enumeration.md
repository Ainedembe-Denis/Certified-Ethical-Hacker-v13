# üìß 5. Techniques for SMTP & DNS Enumeration
### CEH v13 ¬∑ Module 04: Enumeration

> **About these notes:** This guide provides an exhaustive deep-dive into enumerating Simple Mail Transfer Protocol (SMTP) and Domain Name System (DNS) to uncover valid users, internal hostnames, and network infrastructure.

---

## üìë Table of Contents

1. [SMTP Enumeration Concepts](#1-smtp-enumeration-concepts)
   - [Built-in SMTP Commands](#-built-in-smtp-commands)
   - [Manual Probing via Telnet](#-manual-probing-via-telnet)
2. [Automated SMTP Enumeration](#2-automated-smtp-enumeration)
   - [Nmap Scripts (NSE)](#-nmap-scripts-nse)
   - [Metasploit Framework (auxiliary/scanner/smtp/smtp_enum)](#-metasploit-framework)
3. [SMTP Enumeration Tools & AI Prompts](#3-smtp-enumeration-tools--ai-prompts)
4. [DNS Enumeration: Zone Transfer](#4-dns-enumeration-zone-transfer)
   - [dig command (Linux)](#-dig-command-linux)
   - [nslookup command (Windows)](#-nslookup-command-windows)
   - [DNSRecon](#-dnsrecon)
5. [DNS Cache Snooping](#5-dns-cache-snooping)
   - [Non-recursive vs. Recursive Methods](#-non-recursive-vs-recursive-methods)
6. [DNSSEC Zone Walking](#6-dnssec-zone-walking)
   - [NSEC vs. NSEC3](#-nsec-vs-nsec3)
7. [Advanced DNS Enumeration: OWASP Amass](#7-advanced-dns-enumeration-owasp-amass)
8. [DNS Enumeration using Nmap](#8-dns-enumeration-using-nmap)
9. [DNS AI Prompts & Specialized Tools](#9-dns-ai-prompts--specialized-tools)
10. [CEH Exam Traps & Tips (SMTP/DNS)](#10-ceh-exam-traps--tips-smtpdns)

---

## 1. SMTP Enumeration Concepts

Mail systems often use SMTP alongside POP3 and IMAP. SMTP runs on **TCP ports 25, 2525, or 587**. It uses **Mail Exchange (MX) servers** directed via DNS.

### üõ†Ô∏è Built-in SMTP Commands
Attackers use these commands to determine if a user exists on a server based on the server's response.

- **VRFY:** Validates a specific user.
- **EXPN:** Reveals the actual delivery addresses of aliases and mailing lists.
- **RCPT TO:** Defines the recipients of an email message.

### üñ•Ô∏è Manual Probing via Telnet
Attackers can directly interact with SMTP servers to collect users.

**Example 1: Using VRFY**
```bash
$ telnet 192.168.168.1 25
HELO x
250 NYmailserver Hello [10.0.0.86], pleased to meet you
VRFY Jonathan
250 Super-User <Jonathan@NYmailserver>
VRFY Smith
550 Smith... User unknown
```

**Example 2: Using EXPN**
```bash
$ telnet 192.168.168.1 25
HELO x
EXPN Jonathan
250 Super-User <Jonathan@NYmailserver>
EXPN Smith
550 Smith... User unknown
```

**Example 3: Using RCPT TO**
```bash
$ telnet 192.168.168.1 25
HELO x
MAIL FROM:Jonathan
250 Jonathan... Sender ok
RCPT TO:Ryder
250 Ryder... Recipient ok
RCPT TO:Smith
550 Smith... User unknown
```

---

## 2. Automated SMTP Enumeration

### üõ∞Ô∏è Nmap Scripts (NSE)
[Nmap](https://nmap.org) provides powerful scripts to automate user discovery.
- **List Available Commands:** `nmap -p 25,365,587 --script=smtp-commands <IP>`
- **Identify Open Relays:** `nmap -p 25 --script=smtp-open-relay <IP>`
- **Enumerate Users:** `nmap -p 25 --script=smtp-enum-users <IP>`

### üõ°Ô∏è Metasploit Framework
The `auxiliary/scanner/smtp/smtp_enum` module uses a predefined wordlist to find valid accounts.

**Workflow:**
1. `use auxiliary/scanner/smtp/smtp_enum`
2. `show options` (View target requirements).
3. `set RHOSTS <Target_IP>`
4. `set USER_FILE /usr/share/metasploit-framework/data/wordlists/unix_users.txt`
5. `show advanced` (To see deeper customization).
6. `run` (Starts the dictionary attack using VRFY).

---

## 3. SMTP Enumeration Tools & AI Prompts

### üõ†Ô∏è Key SMTP Tools
- **NetScanTools Pro:** [netscantools.com](https://www.netscantools.com) ‚Äî Features an **SMTP Email Generator** to test message delivery and record communications in a log file.
- **smtp-user-enum:** [pentestmonkey.net](https://pentestmonkey.net) ‚Äî A Perl tool to guess usernames using EXPN, VRFY, or RCPT TO.
  - `-m <n>`: Max processes (default 5).
  - `-M <mode>`: Specify command (EXPN, VRFY, RCPT).
  - `-f <addr>`: From address for RCPT TO.

### ü§ñ AI-Powered SMTP Prompts
- **Example #1:** *"Perform SMTP enumeration on target IP 10.10.1.19."*
  - Command: `nmap -p25 --script smtp-enum-users --script-args smtp-enum-users.methods={VRFY, EXPN, RCPT} 10.10.1.19 -oN ~/enumeration_results/smtp_enum_10.10.1.19.txt`
- **Example #2:** *"Perform SMTP enumeration on target IP 10.10.1.19 with Metasploit."*
  - Command: `msfconsole -q -x "use auxiliary/scanner/smtp/smtp_enum; set RHOSTS 10.10.1.19; run; exit"`

---

## 4. DNS Enumeration: Zone Transfer

A **DNS Zone Transfer** copies the zone file from a primary to a secondary DNS server. If the server is misconfigured to allow transfers to anyone, attackers can dump every record.

### üîç dig command (Linux)
1. **Locate Name Servers:** `dig ns <target_domain>`
2. **Attempt Transfer (AXFR):** `dig @<NS_Server_IP> <target_domain> axfr`

### üîç nslookup command (Windows)
[nslookup](https://docs.microsoft.com) can perform manual zone transfers.
1. `nslookup` (Enter interactive mode).
2. `set querytype=soa <target_domain>` (Retrieve administrative Start of Authority record).
3. `ls -d <NS_Server_Domain>` (Attempt the full zone transfer).

### üîç DNSRecon
[DNSRecon](https://github.com) automates the process across all NS records.
- `dnsrecon -t axfr -d <target_domain>`
- `-t axfr`: Specifies the zone transfer enumeration type.

---

## 5. DNS Cache Snooping

This technique allows an attacker to see if a specific DNS record is in the server's cache, indicating a user has recently visited that site.

### üîÑ Non-recursive vs. Recursive Methods

#### 1. Non-recursive Method
- **RD (Recursion Desired) bit set to 0.**
- Command: `dig @<DNS_IP> <Target_Domain> A +norecurse`
- **NOERROR Status:** If the server returns a record, it's cached. If it points to root servers, it's NOT cached.

#### 2. Recursive Method
- **+recurse option enabled.**
- Command: `dig @<DNS_IP> <Target_Domain> A +recurse`
- **TTL Analysis:** If the returned **Time-to-Live (TTL)** value is lower than the initial TTL set by the domain owner, the record was pulled from the cache.

---

## 6. DNSSEC Zone Walking

**DNSSEC** adds digital signatures to records. However, it is susceptible to **Zone Walking**, where an attacker uses cryptographic proofs of non-existence to map the entire zone.

### üõ°Ô∏è NSEC vs. NSEC3
- **NSEC:** Vulnerable to zone walking as it explicitly links to the "next" record in the sequence.
- **NSEC3:** Uses hashed record names to prevent simple walking, though it can still be mapped with tools like `nsec3map`.

### üõ†Ô∏è Zone Walking Tools
- **LDNS-walk:** `ldns-walk @<DNS_IP> <Domain>`
- **DNSRecon:** `dnsrecon -d <Domain> -z` (Enumerate NSEC records).

---

## 7. Advanced DNS Enumeration: OWASP Amass

[OWASP Amass](https://github.com/owasp-amass/amass) is a comprehensive tool for mapping attack surfaces.

| Command Variant | Purpose |
| :--- | :--- |
| **amass enum -d <Domain>** | Basic enumeration (passive + active). |
| **amass enum -passive -d <Domain> -src** | Passive recon only (no direct traffic to target). |
| **amass enum -active -d <Domain> -brute** | Active brute-forcing using wordlists. |
| **amass track -d <Domain> -last 2** | Compare the results of the last two scans. |
| **amass db -dir <folder> -list** | Display stored results from the database. |
| **amass viz -d3 -dir <folder>** | Generate a D3-force HTML visual graph of the network. |

---

## 8. DNS Enumeration using Nmap

Nmap provides specialized NSE scripts for deep DNS discovery.
- **Service Discovery:** `nmap --script=broadcast-dns-service-discovery <Domain>`
- **Subdomain Brute-Force:** `nmap -p 53 --script dns-brute <Domain>`
- **Wildcard Detection:** Nmap identifies wildcard entries as `*A*` (IPv4) or `*AAAA*` (IPv6).
- **Check Recursion:** `nmap -Pn -sU -p 53 --script=dns-recursion <IP>`
- **NSEC Enumeration:** `nmap -sU -p 53 --script dns-nsec-enum --script-args dns-nsec-enum.domains=<Domain> <target>`

---

## 9. DNS AI Prompts & Specialized Tools

### ü§ñ AI-Powered DNS Prompts
- **DNS Enumeration:** *"Use Nmap to perform DNS Enumeration on target domain www.certifiedhacker.com"*
  - Result: `nmap --script dns-brute --script-args dns-brute.domain=certifiedhacker.com -oN ~/dns_brute.txt`
- **Cache Snooping:** *"Use dig command to perform DNS cache snooping on target domain www.certifiedhacker.com using recursive method. Use DNS server IP as 162.241.216.11."*
  - Result: `dig @162.241.216.11 www.certifiedhacker.com +recurse`

### üèóÔ∏è Additional DNS Tools
- **Knock:** [github.com](https://github.com) ‚Äî Subdomain discovery.
- **Subfinder:** [github.com](https://github.com) ‚Äî Fast passive subdomain discovery.
- **Raccoon:** [github.com](https://github.com) ‚Äî All-in-one recon tool.
- **Turbolist3r:** [github.com](https://github.com) ‚Äî Subdomain discovery using subdomain-specific search engines.

---

## 10. CEH Exam Traps & Tips (SMTP/DNS)

| ‚ö†Ô∏è Common Trap | ‚úÖ Correct Understanding |
| :--- | :--- |
| **VRFY vs EXPN** | **VRFY** checks if a single name exists; **EXPN** reveals members of a list (aliases). |
| **AXFR Port** | DNS Zone Transfers (AXFR) use **TCP Port 53**. Standard queries use **UDP 53**. |
| **NSEC3 Use Case** | Used specifically to prevent **Zone Enumeration (Zone Walking)**. |
| **RD Bit** | Setting RD to **0** (Non-recursive) is key for stealthy cache snooping. |
| **Wildcards** | Brute force tools like Nmap detect wildcard entries to avoid false positives. |

---

*üìö CEH v13 ¬∑ Module 04: Enumeration | Last updated: February 2026*
