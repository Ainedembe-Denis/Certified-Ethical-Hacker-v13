# ğŸ›¡ï¸ Scanning Beyond IDS and Firewall
### CEH v13 Â· Module 03: Scanning Networks

> **About these notes:** A practical, exam-ready reference on IDS/firewall evasion techniques â€” covering packet fragmentation, source routing, decoy scanning, IP/MAC spoofing, custom packet crafting, and CEH exam logic.

---

## ğŸ“‘ Table of Contents

1. [Introduction: Evading Defenses](#1-introduction-evading-defenses)
2. [IDS vs. Firewall vs. IPS â€” Key Differences](#2-ids-vs-firewall-vs-ips--key-differences)
3. [Evasion Technique 1: Packet Fragmentation](#3-evasion-technique-1-packet-fragmentation)
4. [Evasion Technique 2: Source Routing](#4-evasion-technique-2-source-routing)
5. [Evasion Technique 3: Source Port Manipulation](#5-evasion-technique-3-source-port-manipulation)
6. [Evasion Technique 4: IP Address Decoy](#6-evasion-technique-4-ip-address-decoy)
7. [Evasion Technique 5: IP Address Spoofing](#7-evasion-technique-5-ip-address-spoofing)
8. [Evasion Technique 6: MAC Address Spoofing](#8-evasion-technique-6-mac-address-spoofing)
9. [Evasion Technique 7: Idle Scan (Zombie Scan)](#9-evasion-technique-7-idle-scan-zombie-scan)
10. [Evasion Technique 8: Custom Packet Crafting](#10-evasion-technique-8-custom-packet-crafting)
11. [Additional Evasion & Timing Tactics](#11-additional-evasion--timing-tactics)
12. [Blue Team â€” Detection & Countermeasures](#12-blue-team--detection--countermeasures)
13. [âœ… Key Takeaways & Exam-Level Points](#-key-takeaways--exam-level-points)
14. [ğŸ“‹ Quick Command Reference Card](#-quick-command-reference-card)
15. [âš ï¸ CEH Exam Traps & Tips](#-ceh-exam-traps--tips)

---

## 1. Introduction: Evading Defenses

Firewalls and IDS (Intrusion Detection Systems) are designed to block or alert on malicious traffic. However, attackers use **evasion techniques** to sneak past these defenses during the scanning phase.

| Component | Role | Evasion Goal |
|-----------|------|--------------|
| **Firewall** | Blocks unauthorized traffic based on rules | Bypass ACLs to reach protected ports |
| **IDS** | Detects suspicious patterns/signatures | Obfuscate traffic to avoid triggering alerts |
| **IPS** | Actively blocks detected threats | Avoid detection to prevent being automatically blocked |

> ğŸ§  **Mental Model:**
> - **Normal Scanning:** "Find open doors."
> - **Evasion Scanning:** "Find open doors without triggering the alarm or being locked out."

---

## 2. IDS vs. Firewall vs. IPS â€” Key Differences

This distinction is **exam-critical**.

| Device | Primary Role | Action Taken | Traffic Path |
|--------|-------------|:------------:|:------------:|
| **Firewall** | Enforce access control policy | Block / Allow packets | Inline |
| **IDS** | Detect suspicious behavior | Alert / Log only | Out-of-band |
| **IPS** | Detect and respond | Block + Alert | Inline |

> ğŸ¯ **CEH Memory Rule:**
> - **Firewall** = Gatekeeper
> - **IDS** = Security Camera (Passive)
> - **IPS** = Security Guard (Active)

---

## 3. Evasion Technique 1: Packet Fragmentation

### ğŸ“Œ Concept
Packet fragmentation splits probe packets into smaller pieces. Many IDS/Firewalls skip fragmented packets to save CPU resources or fail to reassemble them correctly for inspection.

### âš™ï¸ How It Works
- **Mechanic**: Splits the TCP header across multiple fragments. 
- **Evasion**: A signature-based IDS might not see the full "attack signature" in any single fragment.
- **Nmap Option**: `-f` (standard 8-byte fragments) or `-ff` (16-byte). Use `--mtu` for custom sizes.

### âš ï¸ Risks
- Some target hosts may crash or misbehave when reassembling unusual or tiny fragments.
- Modern IDS (like Snort) can reassemble fragments, mitigating this technique.

---

## 4. Evasion Technique 2: Source Routing

### ğŸ“Œ Concept
Normally, routers decide the path packets take. In **Source Routing**, the attacker dictates the path by manipulating the **IP Options field**.

### âš™ï¸ Types
- **Loose Source Routing (LSR)**: The attacker suggests a few routers the packet *must* pass through.
- **Strict Source Routing (SSR)**: The attacker specifies the *entire* path to the destination.

### ğŸ›¡ï¸ Use Case
Dictating the route can help avoid firewalls or routers configured to block traffic from specific segments or to reach targets via "trusted" nodes.

---

## 5. Evasion Technique 3: Source Port Manipulation

### ğŸ“Œ Concept
Firewalls often "trust" traffic coming from **well-known ports** (e.g., DNS port 53, HTTP port 80). Attackers disguise their scan traffic by setting their source port to one of these trusted ports.

### ğŸ› ï¸ Nmap Usage
- **Command**: `-g` or `--source-port`.
- **Logic**: If a firewall rule says "Allow DNS traffic (Port 53)", it might not inspect the *content* of packets coming from port 53.

### ğŸ“Š Commonly Trusted Source Ports
| Port | Service | Reason for Trust |
|:----:|---------|------------------|
| **53** | DNS | Required for basic network functionality |
| **80** | HTTP | Often allowed for web updates/queries |
| **20** | FTP Data | Frequently allowed in legacy configurations |

---

## 6. Evasion Technique 4: IP Address Decoy

### ğŸ“Œ Concept
Multiple fake IP addresses (**decoys**) are used alongside the real attacker IP. This makes it difficult for a defender to distinguish the real source of the scan among the noise.

### ğŸ› ï¸ Nmap Commands
- `-D RND:10 <target>`: Generates 10 random decoy IPs.
- `-D d1,d2,ME,d3 <target>`: Manually specifies decoys and the position of your real IP (**ME**).

### ğŸ“‰ Downsides
- Slows scanning due to increased traffic.
- Can reduce accuracy if the network is congested by decoys.

---

## 7. Evasion Technique 5: IP Address Spoofing

### ğŸ“Œ Concept
The attacker changes the **Source IP** in the packet headers to appear as a different host.

### ğŸ› ï¸ Tool: Hping3
```bash
hping3 <target> -a <spoofed_IP>
```

### âš ï¸ Major Limitation
- **No Handshake**: You cannot complete a TCP 3-way handshake because responses go to the spoofed IP, not the attacker.
- **Usage**: Primarily used for DoS attacks (reflection) or stateless scanning where no response is needed.

---

## 8. Evasion Technique 6: MAC Address Spoofing

### ğŸ“Œ Concept
Firewalls or managed switches may filter based on MAC addresses. Attackers fake their MAC address to appear as a trusted device.

### ğŸ› ï¸ Nmap Options
- `--spoof-mac 0`: Generates a completely random MAC.
- `--spoof-mac Apple`: Generates a MAC from a specific vendor.
- `--spoof-mac <NEW_MAC>`: Manually sets a specific MAC.

---

## 9. Evasion Technique 7: Idle Scan (Zombie Scan)

### ğŸ“Œ Concept
The most stealthy scan. The attacker uses a third-party host (**Zombie**) with a predictable **IP ID sequence** to probe the target. 

### âš™ï¸ Mechanics
1. Attacker checks Zombie's IP ID.
2. Attacker sends spoofed SYN (using Zombie's IP) to the Target.
3. Target replies to Zombie.
4. Attacker checks Zombie's IP ID again. If it jumped by 2, the port is **Open**.

### ğŸ› ï¸ Nmap Command
```bash
sudo nmap -sI <zombie_ip> <target_ip>
```

---

## 10. Evasion Technique 8: Custom Packet Crafting

### ğŸ“Œ Concept
Creating packets with specific parameters (flags, offsets, checksums) to bypass detection or trigger specific responses from the target OS.

### ğŸ› ï¸ Key Tools
- **Colasoft Packet Builder**: GUI-based tool to visually create any type of packet.
- **NetScanTools Pro**: Comprehensive toolkit for network testing and custom packet generation.
- **Scapy (Python)**: Programmable library for manual packet creation.

---

## 11. Additional Evasion & Timing Tactics

- **Randomizing Host Order**: Avoids predictable scanning patterns that look like a sequential sweep.
- **Bad Checksums**: Some IDS ignore corrupted packets, while the target OS might still process them, revealing filtering behavior.
- **Proxy Servers**: Hide the attacker's real location/identity behind chains of proxies.
- **Timing Evasion**: Using Nmap timing templates (`-T0` to `-T5`). `-T0` (Paranoid) is the slowest and most stealthy.

---

## 12. Blue Team â€” Detection & Countermeasures

| Evasion Method | Forensic/Defensive Clue | Countermeasure |
|----------------|-------------------------|----------------|
| **Fragmentation** | High number of tiny fragments | IDS fragment reassembly |
| **Decoy Scanning** | Multiple IPs scanning simultaneously | Contextual flow analysis |
| **Spoofing** | Packets entering interface from "wrong" IPs | Ingress/Egress filtering (BCP38) |
| **MAC Spoofing** | Multiple MACs on one switch port | Port Security (sticky MAC) |

---

## 13. âœ… Key Takeaways & Exam-Level Points

- **Tools to Remember**: Nmap, Hping3, Colasoft Packet Builder.
- **Stealth vs. Noise**: Decoys and fragmentation add noise; Idle scan and Timing (`-T0`) increase stealth.
- **Spoofing vs. Connection**: IP Spoofing prevents a full TCP connection.
- **Active vs. Passive**: IDS is typically passive (Alerts); IPS is active (Blocks).

---

## 14. ğŸ“‹ Quick Command Reference Card

| Goal | Command |
|------|---------|
| Fragment Packets | `nmap -f <target>` |
| Source Port DNS | `nmap -g 53 <target>` |
| IP Decoys (Random 5) | `nmap -D RND:5 <target>` |
| MAC Spoof (Random) | `nmap --spoof-mac 0 <target>` |
| Idle Scan | `nmap -sI <zombie> <target>` |
| Slow Scan (Stealth) | `nmap -T1 <target>` |
| Custom Checksum | `nmap --badsum <target>` |

---

## 15. âš ï¸ CEH Exam Traps & Tips

1. **Trap**: "Does Fragmentation bypass modern IDS?" â†’ **No**, modern IDS reassembles them.
2. **Trap**: "Which technique uses a Zombie?" â†’ **Idle Scan** (`-sI`).
3. **Trap**: "Is Source Routing common today?" â†’ **No**, most routers disable it (LSR/SSR) for security.
4. **Tip**: If an examiner asks how to bypass a firewall whitelisting port 80, the answer is **Source Port Manipulation** (`-g 80`).
5. **Tip**: If you need to hide your identity among many others, use **Decoy Scanning** (`-D`).

---

*ğŸ“š CEH v13 Â· Module 03: Scanning Networks | Last updated: February 2026*