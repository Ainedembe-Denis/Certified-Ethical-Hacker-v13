# üõ°Ô∏è Scanning Beyond IDS and Firewall
### CEH v13 ¬∑ Module 03: Scanning Networks

> **About these notes:** A practical, deeply technical reference on IDS/firewall evasion ‚Äî covering advanced packet fragmentation, source routing, decoy strategies, IP/MAC spoofing, custom packet crafting with Colasoft, and an exhaustive guide to proxies, anonymizers, and censorship circumvention.

---

## üìë Table of Contents

1. [Introduction: Evading Defenses](#1-introduction-evading-defenses)
2. [IDS vs. Firewall vs. IPS ‚Äî Technical Distinctions](#2-ids-vs-firewall-vs-ips--technical-distinctions)
3. [Technique 1: Packet Fragmentation](#3-technique-1-packet-fragmentation)
4. [Technique 2: Source Routing](#4-technique-2-source-routing)
5. [Technique 3: Source Port Manipulation](#5-technique-3-source-port-manipulation)
6. [Technique 4: IP Address Decoy](#6-technique-4-ip-address-decoy)
7. [Technique 5: IP Address Spoofing](#7-technique-5-ip-address-spoofing)
8. [Technique 6: MAC Address Spoofing](#8-technique-6-mac-address-spoofing)
9. [Technique 7: Custom Packet Crafting (Colasoft Deep Dive)](#9-technique-7-custom-packet-crafting-colasoft-deep-dive)
10. [Technique 8: Idle Scan (Zombie Scan)](#10-technique-8-idle-scan-zombie-scan)
11. [Technique 9: Additional Recon Evasion Tactics](#11-technique-9-additional-recon-evasion-tactics)
12. [Anonymity & Censorship Evasion](#12-anonymity--censorship-evasion)
    - [Proxy Servers](#-proxy-servers)
    - [Anonymizers](#-anonymizers)
    - [CyberGhost, Whonix, and Tails](#-cyberghost-whonix-and-tails)
13. [Blue Team ‚Äî Detection & Countermeasures](#13-blue-team--detection--countermeasures)
14. [‚úÖ Master Key Takeaways](#-master-key-takeaways)
15. [üìã Quick Command Reference Card](#-quick-command-reference-card)
16. [‚ö†Ô∏è CEH Exam Traps & Tips](#-ceh-exam-traps--tips)

---

## 1. Introduction: Evading Defenses

Firewalls and IDS (Intrusion Detection Systems) are designed to block or alert on malicious traffic. However, attackers use **evasion techniques** to sneak past these defenses during the scanning phase by mimicking legitimate traffic or breaking attack patterns into unrecognizable pieces.

| Component | Role | Evasion Primary Goal |
|-----------|------|----------------------|
| **Firewall** | Blocks traffic based on policy | Bypass ACLs to reach "forbidden" ports |
| **IDS** | Detects suspicious patterns | Avoid triggering signature-based alerts |
| **IPS** | Blocks threats in real time | Evade detection to prevent automatic lockouts |

---

## 2. IDS vs. Firewall vs. IPS ‚Äî Technical Distinctions

Understanding the device's place in the network is vital for choosing an evasion tactic.

| Device | Action | Traffic Flow | CEH Analogy |
|--------|--------|--------------|--------------|
| **Firewall** | Block / Allow | Inline (Choke Point) | Gatekeeper |
| **IDS** | Alert / Log | Out-of-band (Mirror) | Security Camera |
| **IPS** | Block + Alert | Inline (Active) | Armed Guard |

> üéØ **Exam Tip:** If a scenario mentions "Mirroring traffic" or "SPAN ports," it's talking about a **Passive IDS**. If it mentions "dropping the connection in real time," it's an **IPS**.

---

## 3. Technique 1: Packet Fragmentation

### üìå Concept
Packet fragmentation splits probe packets into smaller pieces to confuse IDS/Firewall analysis and save defensive CPU resources (some filters skip fragmented packets for performance).

### ‚öôÔ∏è How It Works
- **SYN/FIN Scanning Over Fragments**: A specialized technique where TCP headers are split across multiple fragments. 
- **Evasion Logic**: The IDS expects a whole TCP packet to match a signature. When the SYN flag is in Fragment 1 and the Destination Port is in Fragment 2, the signature fails to match.
- **Tools**: Nmap (`-f` or `-ff`) and Zenmap.

### ‚ö†Ô∏è Risks
- **Instability**: Some target systems may crash or hang when reassembling malformed or tiny fragments.
- **Snort stream5**: Modern IDS reassemble fragments before inspection, making this mostly effective against legacy systems.

---

## 4. Technique 2: Source Routing

### üìå Concept
Attackers dictate the exact path a packet takes through the network by manipulating the **IP Options field**.

### ‚öôÔ∏è Types
- **Loose Source Routing (LSR)**: Attacker specifies a few hops; routers choose the rest.
- **Strict Source Routing (SSR)**: Attacker specifies every single hop in the path.

### üõ°Ô∏è Use Case
If a firewall is configured to "Trust traffic from Node B," but blocks traffic from "Attacker Node A," Node A can source-route the packet *through* Node B to reach the target victim.
- **Example**: Firewall allows manipulated port 80 traffic to the victim if it appears to come from a specific routed path.

---

## 5. Technique 3: Source Port Manipulation

### üìå Concept
Firewalls often allow traffic from **well-known ports** (HTTP 80, DNS 53, FTP 21) without deep inspection. Attackers disguise their scanners by setting their source port to these trusted values.

### üõ†Ô∏è Nmap/Zenmap Usage
- **Command**: `-g` or `--source-port`.
- **Logic**: Scanning over a firewall using Zenmap with source port 53 can bypass rules that allow DNS queries.

| Port | Service | Why It Bypasses Rules |
|:----:|---------|-----------------------|
| 53 | DNS | Whitelisted for lookups |
| 80 | HTTP | Allowed for web traffic |
| 21 | FTP | Allowed for file transfers |

---

## 6. Technique 4: IP Address Decoy

### üìå Concept
Attackers mix their real IP with multiple fake IPs (**decoys**) to hide in a crowd of scanning traffic.

### üõ†Ô∏è Nmap Commands
- **Random Decoys**: `nmap -D RND:10 [target]`
- **Manual Decoy List**: `nmap -D decoy1,decoy2,ME,decoy3 [target]`

### üìä Syntax Example (CEH Documented)
Assume **10.10.1.19** is the real attacker and **10.10.1.11** is the target:
```bash
# nmap -D 192.168.0.1,172.120.2.8,192.168.2.8,10.10.1.19,10.10.1.5 10.10.1.11
```
> ÔøΩ The `ME` keyword or placing your real IP in the list ensures you get the results while decoys draw the fire of defenders.

---

## 7. Technique 5: IP Address Spoofing

### üìå Concept
The attacker forge the Source IP address in packet headers to appear as a different host.

### üõ†Ô∏è Tool: Hping3
```bash
# Spoof source as 7.7.7.7 to target www.certifiedhacker.com
hping3 www.certifiedhacker.com -a 7.7.7.7
```

### ‚ö†Ô∏è Limitations
- **No Handshake**: Cannot establish a real TCP connection because the target's SYN-ACK goes to the spoofed host, not the attacker.
- **Usage**: Used for DoS reflection or scanning where only a one-way probe is needed.

---

## 8. Technique 6: MAC Address Spoofing

### üìå Concept
Bypassing MAC-based filters (ACLs) on switches or firewalls by faking a trusted hardware address.

### üõ†Ô∏è Nmap Options
```bash
# Random MAC (generates a completely new identity)
nmap -sT -Pn --spoof-mac 0 [Target IP]

# Vendor-specific MAC (e.g., Apple, Cisco)
nmap -sT -Pn --spoof-mac [Vendor] [Target IP]

# Specific Manual MAC
nmap -sT -Pn --spoof-mac [new MAC] [Target IP]
```

---

## 9. Technique 7: Custom Packet Crafting (Colasoft Deep Dive)

### üìå Concept
Attackers use advanced tools to build packet streams with custom flags, transfer rates, and protocols to bypass specific firewall logic.

### üõ†Ô∏è Tool: Colasoft Packet Builder
**Source**: [https://www.colasoft.com](https://www.colasoft.com)

| View | Purpose |
|------|---------|
| **Packet List** | Displays all constructed packets; allows selection for editing |
| **Decode Editor** | Edit packets logically (change values in boxes) without needing to know offsets/lengths |
| **Hex Editor** | Edit raw hexadecimal or ASCII characters directly |

### ‚öôÔ∏è Key Features
- **Creating Packets**: Use "Add" or "Insert" command in the Edit menu.
- **Sending Controls**: Specify interval between packets, loop times, and delay between loops.
- **Attack Potential**: Attackers use this to create fragmented packets for evasion or flood targets for **DoS attacks**.

> üí° **Related Tool**: **NetScanTools Pro** ([https://www.netscantools.com](https://www.netscantools.com)) is another major packet-crafting suite for defenders and attackers.

---

## 10. Technique 8: Idle Scan (Zombie Scan)

The most stealthy method. The attacker uses a third-party host (**Zombie**) with a predictable IP ID sequence. The target only sees the Zombie's IP.

---

## 11. Technique 9: Additional Recon Evasion Tactics

### üîπ Randomizing Host Order
- **Logic**: Scanning targets in random order prevents traditional IDS from detecting a "sequential sweep" (e.g., scanning 1, then 2, then 3).
- **Tool**: Nmap `--randomize-hosts` (or Zenmap checkboxes).

### üîπ Sending Bad Checksums
- **Logic**: Use the `--badsum` flag in Nmap. 
- **Forensic Deduction**:
    - **Get a response?** ‚Üí The IDS or Firewall failed to verify the checksum (improperly configured).
    - **No response?** ‚Üí The system is well-configured and dropped the garbage packet.

---

## 12. Anonymity & Censorship Evasion

### üåê Proxy Servers
A proxy server is an application mediating between a client and a destination server.

| Proxy Use Case | Benefit |
|----------------|---------|
| **Intermediary** | Serves as a firewall to protect the local network |
| **Anonymizer** | Mask your real IP in logs (logs show the proxy's IP) |
| **Multiplexer** | Connect many local PCs via one public IP (NAT/PAT) |
| **Bandwidth Saving** | Caches common resources to speed up browsing |

#### Proxy Chaining
Attackers chain multiple proxies to increase anonymity. Identification information is stripped at each hop. The larger the chain, the harder it is to trace.
- **User ‚Üí Proxy A ‚Üí Proxy B ‚Üí Proxy C ‚Üí Web Server**

### üõ°Ô∏è Anonymizers
Intermediate servers that make web surfing untraceable by encrypting data and stripping IP info.

| Type | How It Works | Advantage |
|------|--------------|-----------|
| **Networked** | Traffic hops through several computers (e.g., Tor) | Complex analysis makes tracking cumbersome |
| **Single-Point** | Traffic passes through one website intermediary | Hides IP effectively but is easier to analyze |

### üõ†Ô∏è Toolset: Proxies & Anonymizers
- **CyberGhost VPN**: Encrypts connection; does not keep logs.
- **Whonix**: Desktop OS running inside virtual machines, routing all traffic through Tor.
- **Tails**: Live OS (USB/SD) that leave no trace on the computer.
- **Proxy Switcher**: Quickly switch between proxy profiles to evade bans.
- **Other tools**: Burp Suite, Tor, Psiphon, TunnelBear, AstrillVPN.

---

## 13. Blue Team ‚Äî Detection & Countermeasures

- **Snort stream5**: Reassembles fragments to catch fragmentation attacks.
- **Ingress/Egress Filtering**: Blocks spoofed packets at the network edge.
- **Stateful Inspection**: Prevents source port manipulation by tracking connection history.

---

## 14. ‚úÖ Master Key Takeaways

1. **Fragmentation & Decoys** add "noise" to hide the attacker.
2. **IP Spoofing** is best for DoS, not for full TCP scanning.
3. **Proxies** mask your source IP in server logs.
4. **Packet Crafting** (Colasoft) allows for custom evasion signatures and DoS.
5. **Bad Checksums** test whether a firewall is actually checking data integrity.

---

## 15. üìã Quick Command Reference Card

| Goal | Tool / Command |
|------|----------------|
| Fragment Scanning | `nmap -f <target>` |
| Hide in Decoys | `nmap -D 1.1.1.1,2.2.2.2,ME <target>` |
| MAC Spoofing | `nmap --spoof-mac 0 <target>` |
| IP Spoofing | `hping3 <target> -a <spoofed_IP>` |
| Bad Checksums | `nmap --badsum <target>` |
| Use Proxy | `proxychains nmap -sT <target>` |

---

## 16. ‚ö†Ô∏è CEH Exam Traps & Tips

- **Trap**: "Which technique establishing a connection while hiding its source?" ‚Üí **Idle Scan** (Proxy servers also mediate).
- **Tip**: Remember **Colasoft Packet Builder's three views**: Packet List, Decode Editor, and Hex Editor.
- **Tip**: **Standardization** ‚Äî Anonymizers ensure privacy until you voluntarily disclose info on a form.
- **Tip**: **SSR vs LSR** ‚Äî Strict Source Routing (SSR) means *every* hop is defined.

---

*üìö CEH v13 ¬∑ Module 03: Scanning Networks | Last updated: February 2026*