# ðŸ›¡ï¸ Network Scanning Countermeasures
### CEH v13 Â· Module 03: Scanning Networks

> **About these notes:** In ethical hacking, the "pen tester" must perform an additional task that a malicious hacker skips: adopting countermeasures. This guide details defenses against ping sweeps, port scans, banner grabbing, and IP spoofing, using technical configurations and specialized detection tools.

---

## ðŸ“‘ Table of Contents

1. [Introduction: The Role of a Pen Tester](#1-introduction-the-role-of-a-pen-tester)
2. [Ping Sweep Countermeasures](#2-ping-sweep-countermeasures)
3. [Port Scanning Countermeasures](#3-port-scanning-countermeasures)
4. [Banner Grabbing Countermeasures](#4-banner-grabbing-countermeasures)
    - [Disabling/Changing Banners](#-disablingchanging-banners)
    - [Hiding File Extensions](#-hiding-file-extensions)
5. [IP Spoofing Detection Techniques](#5-ip-spoofing-detection-techniques)
6. [IP Spoofing Countermeasures](#6-ip-spoofing-countermeasures)
7. [Scanning Detection & Prevention Tools](#7-scanning-detection--prevention-tools)

---

## 1. Introduction: The Role of a Pen Tester

Countermeasures are essential because knowing security loopholes is worthless unless you protect them. A pen tester identifies vulnerabilities and then provides the blueprint for defending against them.

---

## 2. Ping Sweep Countermeasures

| Countermeasure | Implementation Details |
|----------------|------------------------|
| **Firewall Configuration** | Block incoming ICMP echo requests from unknown/untrusted sources |
| **IDS/IPS (e.g., Snort)** | Use alerts to detect and prevent mass ICMP probes |
| **ICMP Traffic Evaluation** | Carefully monitor the type of ICMP traffic flowing through the network |
| **Connection Termination** | Automatically cut connections with any host sending > 10 ICMP ECHO requests |
| **DMZ Strategy** | Allow only specific commands (ECHO_REPLY, HOST UNREACHABLE, TIME EXCEEDED) in the DMZ |
| **ACL Filtering** | Limit ICMP traffic to specific trusted IP addresses (e.g., ISP maintenance IPs) |
| **Rate Limiting** | Implement packet rate limiting to reduce the efficacy of scanning techniques |
| **Network Segmentation** | Break the network into smaller, isolated segments to limit discovery scope |
| **Private addressing & NAT** | Use RFC 1918 ranges and implement NAT at boundary routers to hide internal IPs |

---

## 3. Port Scanning Countermeasures

Open ports are an easy means for an attacker to break into a network. Defensive measures include:

- **Intelligent Firewalls**: Firewalls must examine data in each packet, not just TCP headers, to detect sophisticated scan probes.
- **Self-Scanning**: Regularly run port scanning tools against your own hosts to verify if firewall detection rules are working.
- **Firmware Integrity**: Ensure all routers, IDS, and firewalls are running the latest security patches.
- **Extreme Port Lockdown**: Filter sensitive ports: **135â€“159, 256â€“258, 389, 445, 1080, 1745, and 3268**.
- **ICMP Inbound Blocking**: Block inbound ICMP messages and outbound **ICMP type-3 unreachable** messages at the border routers.
- **Source Routing Defense**: Configure routers and firewalls to explicitly block source-routing techniques that attempt to bypass segmentation.
- **Honeypots**: Configure firewalls to forward scan attempts to empty hosts or honeypots to waste the attacker's time.
- **Advanced Defense Tactics**:
    - **Port Knocking**: Hide ports behind a secret sequence of connection attempts.
    - **TCP Wrappers**: Limit network access based on domain names or IP addresses at the application layer.
    - **Egress Filtering**: Control outbound traffic to identify compromised internal hosts performing external scans.
    - **VLANs**: Isolate different traffic types to restrict lateral movement after a port is compromised.

---

## 4. Banner Grabbing Countermeasures

### ðŸ”¹ Disabling or Changing Banners
Attackers use banners to identify the OS, server type, and versions. 

**Defensive Actions:**
- **False Banners**: Mislead attackers with misleading server strings.
- **Server Masking**: Use tools to completely change banner info.
- **HTTP Header Cleaning**: Remove unnecessary headers (like `X-Powered-By`) and response data.
- **Configuration Hardening**:
    - **Apache**: 
        - Set `ServerSignature Off` and `ServerTokens Prod` in `httpd.conf`.
        - Use `mod_headers` to set a custom `Server` header name.
    - **IIS (UrlScan)**: 
        - Modify `UrlScan.ini` (Set `RemoveServerHeader=1`).
        - Set `AlternateServerName` to a generic value.
- **Method Restriction**: Disable dangerous HTTP methods (`CONNECT`, `PUT`, `DELETE`, `OPTIONS`).

### ðŸ”¹ Hiding File Extensions
Extensions (e.g., `.asp`, `.php`) reveal underlying technology.
- **Hide Extensions**: Use URL rewriting or server-side configurations to mask technology.
- **Map Swapping**: Replace mappings (e.g., treat `.asp` as `.foo` or `.htm`).
- **Encrypted Communication**: Replace clear-text protocols (HTTP, FTP, Telnet) with secure counterparts (HTTPS, SFTP, SSH) to encrypt the handshake and banner info.

---

## 5. IP Spoofing Detection Techniques

### ðŸ•µï¸â€â™‚ï¸ Direct TTL Probes
Send a ping request to the legitimate host and compare the returned TTL with the initial packet.
- **Standard TTLs**: 
    - **TCP/UDP**: 64, 128
    - **ICMP**: 128, 255
- **Detection**: If the reply TTL does not match the packet, it is spoofed.
- **Limitation**: Successful when the attacker is in a different subnet; however, can produce **false negatives** if the attacker knows the exact hop count.

> ðŸ’¡ **Simply Put:**
> Think of TTL as a "Passport Stamp". If a packet says it came from far away but its "stamps" show it only crossed one border, someone is lying about where they started.

### ðŸ”¢ IP Identification Number (IPID)
Monitor the unique incrementing IPID in packet headers.
- **Process**: Send a probe to the source IP. The reply IPID should be slightly greater than the probe IPID.
- **Spoofing Indicator**: If the IPID is not close/sequential, the source address is forged.
- **Advantage**: Effective even when the attacker and target are on the same subnet.

> ðŸ’¡ **Simply Put:**
> Every packet a computer sends has a "Ticket Number" that goes up by 1. If you ask a computer for its current ticket number and it's **100**, but a suspicious packet just arrived claiming to be from that same computer with ticket number **5000**, it's a fake.

### ðŸŒŠ TCP Flow Control Method
Exploits the sliding window principle and how attackers handle congestion.
- **Logic**: Attackers sending spoofed packets usually cannot see the target's SYN-ACK and thus cannot respond to window size changes.
- **Detection**: 
    - Set the `SYN-ACK` window size to **zero**.
    - If the sender continues sending data packets beyond the window size, they are definitely spoofed.
    - **Handshake Check**: In a genuine client, the sender must respond only with an ACK (no data) when the window is zero.

> ðŸ’¡ **Simply Put:**
> Window Size is like a "Bucket". If you tell someone your bucket is **full (Zero size)**, a real person stops pouring. A "blind" attacker (spoofing) can't see your bucket is full and keeps pouring anyway, spilling data everywhere and getting caught.

---

## 6. IP Spoofing Countermeasures

- **Avoid Trust Relationships**: Never rely solely on IP-based authentication. Always use passwords or multi-factor authentication.
- **Ingress/Egress Filtering**: Block spoofed traffic at the router level by dropping packets with source addresses outside the defined network range.
- **Random Initial Sequence Numbers (ISNs)**: Ensure ISNs are not based on predictable timed counters to prevent session hijacking.
- **Strong Encryption (IPSec)**: The best defense. Encrypted packets provide data authentication and integrity, making spoofing nearly impossible to exploit.
- **Advanced Mitigation**:
    - **IPv6 Migration**: Use dynamic IPv6 address variation (random address generators) to reduce the window of vulnerability.
    - **Behemoth Scrubbers**: Application-specific devices capable of deep packet inspection at speeds of 100M packets/s.

---

## 7. Scanning Detection & Prevention Tools

| Tool | Focus | Key Feature |
|------|-------|-------------|
| **ExtraHop** | Visibility | Real-time discovery of all devices (including IoT) and SSL/TLS decryption analysis. |
| **Splunk ES** | Intelligence | Automatic identification of malicious scanning patterns via SIEM analysis. |
| **Scanlogd** | Detection | Specifically designed to detect port scans in system logs. |
| **Vectra Detect** | AI Analysis | Uses machine learning to identify lateral movement and scanning. |
| **IBM QRadar XDR** | Response | Comprehensive eXtended Detection and Response for automated mitigation. |

---

*ðŸ“š CEH v13 Â· Module 03: Scanning Networks | Last updated: February 2026*
